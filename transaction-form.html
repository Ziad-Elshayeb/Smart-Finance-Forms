<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Confirmation Form</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .form-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .form-header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .form-body {
            padding: 40px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, select, textarea {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .select2-container--default .select2-selection--single {
            height: 48px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 44px;
            padding-left: 16px;
            font-size: 14px;
        }

        .select2-container--default.select2-container--focus .select2-selection--single {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn-group {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 32px;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .status-message {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: none;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .form-body {
                padding: 24px;
            }

            .form-header {
                padding: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-header">
            <h1><i class="fas fa-exchange-alt"></i> Transaction Confirmation</h1>
            <p>Confirm or update transaction details</p>
        </div>
        
        <div class="form-body">
            <div id="statusMessage" class="status-message"></div>
            
            <form id="transactionForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="status">Status *</label>
                        <select id="status" name="status" required>
                            <option value="">Select Status</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Canceled">Canceled</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="value">Value *</label>
                        <input type="number" id="value" name="value" step="0.01" required placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label for="currency">Currency *</label>
                        <input type="text" id="currency" name="currency" required placeholder="USD">
                    </div>

                    <div class="form-group">
                        <label for="transaction_date">Transaction Date *</label>
                        <input type="datetime-local" id="transaction_date" name="transaction_date" required>
                    </div>

                    <div class="form-group">
                        <label for="sender">Sender *</label>
                        <select id="sender" name="sender" required>
                            <option value="">Select or type sender</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="sender_account">Sender Account *</label>
                        <input type="text" id="sender_account" name="sender_account" required placeholder="Account number or name">
                    </div>

                    <div class="form-group">
                        <label for="receiver">Receiver *</label>
                        <select id="receiver" name="receiver" required>
                            <option value="">Select or type receiver</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="receiver_account">Receiver Account *</label>
                        <input type="text" id="receiver_account" name="receiver_account" required placeholder="Account number or name">
                    </div>

                    <div class="form-group">
                        <label for="reference_id">Reference ID</label>
                        <input type="text" id="reference_id" name="reference_id" placeholder="Transaction reference">
                    </div>

                    <div class="form-group">
                        <label for="type">Type *</label>
                        <select id="type" name="type" required>
                            <option value="">Select Type</option>
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="category">Category *</label>
                        <select id="category" name="category" required>
                            <option value="">Select Category</option>
                            <option value="Salary">Salary</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Food">Food</option>
                            <option value="Transportation">Transportation</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="reporter_name">Reporter Name</label>
                        <input type="text" id="reporter_name" name="reporter_name" placeholder="Your name">
                    </div>

                    <div class="form-group full-width">
                        <label for="notes">Notes</label>
                        <textarea id="notes" name="notes" placeholder="Additional transaction notes..."></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label for="reporter_notes">Reporter Notes</label>
                        <textarea id="reporter_notes" name="reporter_notes" placeholder="Reporter's notes..."></textarea>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Confirm Transaction
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        <i class="fas fa-undo"></i> Reset Form
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // Predefined data for form prefill
        const predefinedData = {
            "Status": "confirmedconfirmed",
            "value": "3000",
            "currency": "EGP",
            "transaction_date": "10 Apr 2025 06:09 PM",
            "sender": "ahmed",
            "receiver": "Ziad",
            "reference_id": "510021196275",
            "notes": "Living Expenses",
            "sender_account": "ahmedelshayeb2004@instapay",
            "receiver_account": "ziadelshayeb2003@instapay",
            "namesList": "ziad, ahmed",
            "categoriesList": "Salary, Shopping"
        };

        // Function to check if we need to redirect from URL parameters
        function checkForRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check if we have a redirect_from parameter
            if (urlParams.has('redirect_from')) {
                const redirectFrom = urlParams.get('redirect_from');
                const statusMessage = $('#statusMessage');
                
                if (redirectFrom === 'add-user') {
                    // Get the new user name
                    const newUser = urlParams.get('new_user') || '';
                    if (newUser) {
                        // Add to the namesList
                        if (!predefinedData.namesList.includes(newUser)) {
                            predefinedData.namesList += `, ${newUser}`;
                            
                            // Show success message
                            statusMessage.removeClass('status-error').addClass('status-success');
                            statusMessage.html(`<i class="fas fa-check-circle"></i> User "${newUser}" added successfully!`);
                            statusMessage.show();
                            
                            // Refresh the dropdown lists
                            populateNameDropdowns();
                        }
                    }
                } else if (redirectFrom === 'add-category') {
                    // Get the new category name
                    const newCategory = urlParams.get('new_category') || '';
                    if (newCategory) {
                        // Add to the categoriesList
                        if (!predefinedData.categoriesList.includes(newCategory)) {
                            predefinedData.categoriesList += `, ${newCategory}`;
                            
                            // Show success message
                            statusMessage.removeClass('status-error').addClass('status-success');
                            statusMessage.html(`<i class="fas fa-check-circle"></i> Category "${newCategory}" added successfully!`);
                            statusMessage.show();
                            
                            // Refresh the category dropdown
                            populateCategoryDropdown();
                        }
                    }
                } else if (redirectFrom === 'add-account') {
                    // Get the new account details
                    const accountOwner = urlParams.get('account_owner') || '';
                    const accountValue = urlParams.get('account_value') || '';
                    
                    if (accountOwner && accountValue) {
                        // Set the account value in the corresponding field
                        if (accountOwner.toLowerCase() === $('#sender').val().toLowerCase()) {
                            $('#sender_account').val(accountValue);
                        } else if (accountOwner.toLowerCase() === $('#receiver').val().toLowerCase()) {
                            $('#receiver_account').val(accountValue);
                        }
                        
                        // Show success message
                        statusMessage.removeClass('status-error').addClass('status-success');
                        statusMessage.html(`<i class="fas fa-check-circle"></i> Account for "${accountOwner}" added successfully!`);
                        statusMessage.show();
                    }
                }
                
                // Remove the redirect parameters from URL to prevent reapplying on refresh
                const newUrl = window.location.pathname + '?' + 
                    Array.from(urlParams.entries())
                        .filter(([key]) => !['redirect_from', 'new_user', 'new_category', 'account_owner', 'account_value'].includes(key))
                        .map(([key, value]) => `${key}=${value}`)
                        .join('&');
                
                window.history.replaceState({}, document.title, newUrl);
            }
        }

        // Function to populate sender and receiver dropdowns
        function populateNameDropdowns() {
            // Clear existing options except the placeholder
            $('#sender').find('option:not(:first)').remove();
            $('#receiver').find('option:not(:first)').remove();
            
            // Parse names list and remove duplicates (case-insensitive)
            const namesSet = new Set();
            
            // Only split if namesList is a non-empty string
            if (predefinedData.namesList && typeof predefinedData.namesList === 'string') {
                predefinedData.namesList.split(',').forEach(name => {
                    const trimmedName = name.trim();
                    if (trimmedName) {
                        namesSet.add(trimmedName.toLowerCase());
                    }
                });
            }
            
            // Convert set back to array and sort alphabetically
            const uniqueNames = Array.from(namesSet).sort().map(name => 
                name.charAt(0).toUpperCase() + name.slice(1) // Capitalize first letter
            );
            
            // Populate sender dropdown with unique names
            uniqueNames.forEach(name => {
                $('#sender').append(new Option(name, name, false, false));
            });
            
            // Add "Add New User" option to sender dropdown
            $('#sender').append(new Option('+ Add New User', 'add_new_user', false, false));
            
            // Populate receiver dropdown with unique names
            uniqueNames.forEach(name => {
                $('#receiver').append(new Option(name, name, false, false));
            });
            
            // Add "Add New User" option to receiver dropdown
            $('#receiver').append(new Option('+ Add New User', 'add_new_user', false, false));
            
            // Re-initialize select2
            $('#sender, #receiver').select2({
                placeholder: function() {
                    return $(this).data('placeholder') || 'Select or type...';
                },
                allowClear: true
            });
        }

        // Function to populate category dropdown
        function populateCategoryDropdown() {
            // Clear existing options except the placeholder
            $('#category').find('option:not(:first)').remove();
            
            // Parse categories list
            const categoriesList = predefinedData.categoriesList.split(',').map(category => category.trim());
            
            // Populate category dropdown
            categoriesList.forEach(category => {
                if (category) {
                    $('#category').append(new Option(category, category, false, false));
                }
            });
            
            // Add "Add New Category" option
            $('#category').append(new Option('+ Add New Category', 'add_new_category', false, false));
            
            // Re-initialize select2
            $('#category').select2({
                placeholder: function() {
                    return $(this).data('placeholder') || 'Select or type...';
                },
                allowClear: true
            });
        }

        // Function to handle dropdown selection changes
        function handleDropdownChanges() {
            // Handle sender selection change
            $('#sender').on('change', function() {
                const selectedValue = $(this).val();
                
                if (selectedValue === 'add_new_user') {
                    // Store current form data in URL parameters
                    saveFormStateToUrl();
                    
                    // Redirect to add user form
                    window.location.href = 'add-user-form.html?return_to=transaction-form.html';
                }
            });
            
            // Handle receiver selection change
            $('#receiver').on('change', function() {
                const selectedValue = $(this).val();
                
                if (selectedValue === 'add_new_user') {
                    // Store current form data in URL parameters
                    saveFormStateToUrl();
                    
                    // Redirect to add user form
                    window.location.href = 'add-user-form.html?return_to=transaction-form.html';
                }
            });
            
            // Handle category selection change
            $('#category').on('change', function() {
                const selectedValue = $(this).val();
                
                if (selectedValue === 'add_new_category') {
                    // Store current form data in URL parameters
                    saveFormStateToUrl();
                    
                    // Redirect to add category form
                    window.location.href = 'add-category-form.html?return_to=transaction-form.html';
                }
            });
            
            // Handle sender account field
            $('#sender').on('change', function() {
                const selectedUser = $(this).val();
                
                if (selectedUser && selectedUser !== 'add_new_user') {
                    // Check if there's an existing account for this user
                    // If not, suggest adding a new account
                    const accountField = $('#sender_account');
                    if (!accountField.val()) {
                        const addAccountButton = $('<button>', {
                            type: 'button',
                            class: 'btn btn-secondary',
                            text: 'Add Account',
                            style: 'margin-top: 5px; padding: 8px 16px; font-size: 12px;',
                            click: function() {
                                // Get the current sender/receiver values
                                const sender = $('#sender').val();
                                const senderAccount = $('#sender_account').val() || '';
                                const receiver = $('#receiver').val();
                                const receiverAccount = $('#receiver_account').val() || '';
                                
                                // Show modal or prompt for account
                                const newAccount = prompt(`Enter account for ${sender}:`, senderAccount);
                                
                                if (newAccount) {
                                    // Set the account value
                                    $('#sender_account').val(newAccount);
                                    
                                    // Submit account data to webhook
                                    submitAccountData(sender, newAccount, receiver, receiverAccount);
                                }
                            }
                        });
                        
                        // Remove any existing button
                        accountField.parent().find('button').remove();
                        
                        // Add the button after the account field
                        accountField.after(addAccountButton);
                    }
                }
            });
            
            // Handle receiver account field
            $('#receiver').on('change', function() {
                const selectedUser = $(this).val();
                
                if (selectedUser && selectedUser !== 'add_new_user') {
                    // Check if there's an existing account for this user
                    // If not, suggest adding a new account
                    const accountField = $('#receiver_account');
                    if (!accountField.val()) {
                        const addAccountButton = $('<button>', {
                            type: 'button',
                            class: 'btn btn-secondary',
                            text: 'Add Account',
                            style: 'margin-top: 5px; padding: 8px 16px; font-size: 12px;',
                            click: function() {
                                // Get the current sender/receiver values
                                const sender = $('#sender').val();
                                const senderAccount = $('#sender_account').val() || '';
                                const receiver = $('#receiver').val();
                                const receiverAccount = $('#receiver_account').val() || '';
                                
                                // Show modal or prompt for account
                                const newAccount = prompt(`Enter account for ${receiver}:`, receiverAccount);
                                
                                if (newAccount) {
                                    // Set the account value
                                    $('#receiver_account').val(newAccount);
                                    
                                    // Submit account data to webhook
                                    submitAccountData(sender, senderAccount, receiver, newAccount);
                                }
                            }
                        });
                        
                        // Remove any existing button
                        accountField.parent().find('button').remove();
                        
                        // Add the button after the account field
                        accountField.after(addAccountButton);
                    }
                }
            });
            
            // Function to submit account data to webhook
            async function submitAccountData(sender, senderAccount, receiver, receiverAccount) {
                const statusMessage = $('#statusMessage');
                
                try {
                    // Validate fields
                    if (!sender || !receiver) {
                        throw new Error('Sender and Receiver names are required');
                    }
                    
                    // Prepare data for API
                    const accountData = {
                        'Sender': sender,
                        'Sender_Account': senderAccount,
                        'Receiver': receiver,
                        'Receiver_Account': receiverAccount
                    };
                    
                    // Only submit if we have at least one account
                    if (!senderAccount && !receiverAccount) {
                        return; // No accounts to submit
                    }
                    
                    const response = await fetch('https://ziadelshayeb1.app.n8n.cloud/webhook/user_account', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(accountData)
                    });
                    
                    if (response.ok) {
                        statusMessage.removeClass('status-error').addClass('status-success');
                        statusMessage.html('<i class="fas fa-check-circle"></i> Account information saved successfully!');
                        statusMessage.show();
                        
                        // Hide message after a few seconds
                        setTimeout(() => {
                            statusMessage.hide();
                        }, 3000);
                    } else {
                        throw new Error(`Server error: ${response.status}`);
                    }
                } catch (error) {
                    statusMessage.removeClass('status-success').addClass('status-error');
                    statusMessage.html('<i class="fas fa-exclamation-circle"></i> Error: ' + error.message);
                    statusMessage.show();
                }
            }
        }

        // Function to save current form state to localStorage
        function saveFormStateToStorage() {
            const form = document.getElementById('transactionForm');
            const formData = new FormData(form);
            const data = {};
            
            // Convert FormData to object
            for (let [key, value] of formData.entries()) {
                if (value) {
                    data[key] = value;
                }
            }
            
            // Add namesList and categoriesList
            data.namesList = predefinedData.namesList;
            data.categoriesList = predefinedData.categoriesList;
            
            // Save to localStorage
            localStorage.setItem('transactionFormState', JSON.stringify(data));
        }

        // Function to load form state from localStorage
        function loadFormStateFromStorage() {
            const savedState = localStorage.getItem('transactionFormState');
            if (!savedState) return false;
            
            try {
                const data = JSON.parse(savedState);
                
                // Update predefinedData with saved lists
                if (data.namesList) {
                    predefinedData.namesList = data.namesList;
                }
                
                if (data.categoriesList) {
                    predefinedData.categoriesList = data.categoriesList;
                }
                
                // Populate dropdowns with saved data
                populateNameDropdowns();
                populateCategoryDropdown();
                
                // Fill in all fields from saved data
                for (const [key, value] of Object.entries(data)) {
                    if (key !== 'namesList' && key !== 'categoriesList') {
                        const field = document.getElementById(key.toLowerCase());
                        if (field) {
                            if (field.tagName === 'SELECT') {
                                // For select2 dropdowns
                                const option = new Option(value, value, true, true);
                                $(field).append(option).trigger('change');
                            } else {
                                field.value = value;
                            }
                        }
                    }
                }
                
                return true;
            } catch (error) {
                console.error('Error loading saved form state:', error);
                return false;
            }
        }

        // Function to save current form state to URL
        function saveFormStateToUrl() {
            const form = document.getElementById('transactionForm');
            const formData = new FormData(form);
            const urlParams = new URLSearchParams();
            
            for (let [key, value] of formData.entries()) {
                if (value) {
                    urlParams.append(key, value);
                }
            }
            
            // Store namesList and categoriesList
            urlParams.append('namesList', predefinedData.namesList);
            urlParams.append('categoriesList', predefinedData.categoriesList);
            
            // Update URL without reloading
            const newUrl = window.location.pathname + '?' + urlParams.toString();
            window.history.replaceState({}, document.title, newUrl);
            
            // Also save to localStorage for persistence across refreshes
            saveFormStateToStorage();
        }

        // Convert transaction date format
        function convertDateFormat(dateString) {
            // Convert "10 Apr 2025 06:09 PM" to datetime-local format
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                return new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            }
            return null;
        }

        // Prefill form with predefined data
        function prefillForm() {
            // Handle status - clean up the duplicated value
            let status = predefinedData.Status.toLowerCase();
            if (status === "confirmedconfirmed") {
                status = "Confirmed";
            }
            $('#status').val(status).trigger('change');

            // Handle other fields
            $('#value').val(predefinedData.value);
            $('#currency').val(predefinedData.currency);
            
            // Convert and set transaction date
            const formattedDate = convertDateFormat(predefinedData.transaction_date);
            if (formattedDate) {
                $('#transaction_date').val(formattedDate);
            } else {
                // Fallback to current date
                const now = new Date();
                const currentFormattedDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                $('#transaction_date').val(currentFormattedDate);
            }

            // Set sender and receiver from predefined data
            if (predefinedData.sender) {
                $('#sender').val(predefinedData.sender).trigger('change');
            }
            
            if (predefinedData.receiver) {
                $('#receiver').val(predefinedData.receiver).trigger('change');
            }

            $('#reference_id').val(predefinedData.reference_id);
            $('#notes').val(predefinedData.notes);
            $('#sender_account').val(predefinedData.sender_account);
            $('#receiver_account').val(predefinedData.receiver_account);
        }

        $(document).ready(function() {
            // Initialize Select2 for status and type
            $('#status, #type').select2({
                placeholder: function() {
                    return $(this).data('placeholder') || 'Select...';
                },
                allowClear: true
            });

            // Set up form change monitoring to save state automatically
            $('#transactionForm input, #transactionForm select, #transactionForm textarea').on('change', function() {
                // Save form state whenever any field changes
                saveFormStateToStorage();
            });
            
            // Special handling for Select2 dropdowns which need a different event
            $('#status, #type, #sender, #receiver, #category').on('select2:select select2:unselect', function() {
                saveFormStateToStorage();
            });
            
            // Load parameters from URL
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check if sender and receiver are null or not present in URL
            const senderIsNull = urlParams.has('sender') && (!urlParams.get('sender') || urlParams.get('sender').toLowerCase() === 'null');
            const receiverIsNull = urlParams.has('receiver') && (!urlParams.get('receiver') || urlParams.get('receiver').toLowerCase() === 'null');
            
            // If both sender and receiver are null, add account buttons automatically
            if (senderIsNull && receiverIsNull) {
                // Add Account buttons will be added after form is loaded
                setTimeout(() => {
                    // Add button for sender account
                    const senderAccountField = $('#sender_account');
                    if (senderAccountField.parent().find('button').length === 0) {
                        const addSenderAccountButton = $('<button>', {
                            type: 'button',
                            class: 'btn btn-secondary',
                            text: 'Add Account',
                            style: 'margin-top: 5px; padding: 8px 16px; font-size: 12px;',
                            click: function() {
                                const sender = $('#sender').val() || 'sender';
                                const senderAccount = $('#sender_account').val() || '';
                                const newAccount = prompt(`Enter account for ${sender}:`, senderAccount);
                                
                                if (newAccount) {
                                    $('#sender_account').val(newAccount);
                                    submitAccountData(
                                        $('#sender').val(),
                                        newAccount,
                                        $('#receiver').val(),
                                        $('#receiver_account').val() || ''
                                    );
                                }
                            }
                        });
                        senderAccountField.after(addSenderAccountButton);
                    }
                    
                    // Add button for receiver account
                    const receiverAccountField = $('#receiver_account');
                    if (receiverAccountField.parent().find('button').length === 0) {
                        const addReceiverAccountButton = $('<button>', {
                            type: 'button',
                            class: 'btn btn-secondary',
                            text: 'Add Account',
                            style: 'margin-top: 5px; padding: 8px 16px; font-size: 12px;',
                            click: function() {
                                const receiver = $('#receiver').val() || 'receiver';
                                const receiverAccount = $('#receiver_account').val() || '';
                                const newAccount = prompt(`Enter account for ${receiver}:`, receiverAccount);
                                
                                if (newAccount) {
                                    $('#receiver_account').val(newAccount);
                                    submitAccountData(
                                        $('#sender').val(),
                                        $('#sender_account').val() || '',
                                        $('#receiver').val(),
                                        newAccount
                                    );
                                }
                            }
                        });
                        receiverAccountField.after(addReceiverAccountButton);
                    }
                }, 500); // Small delay to ensure the form is fully loaded
            }
            
            // Override predefinedData with namesList and categoriesList from URL if present
            if (urlParams.has('namesList')) {
                predefinedData.namesList = urlParams.get('namesList');
            }
            
            if (urlParams.has('categoriesList')) {
                predefinedData.categoriesList = urlParams.get('categoriesList');
            }
            
            // Extract sender and receiver from URL if present
            const urlSender = urlParams.get('sender');
            const urlReceiver = urlParams.get('receiver');
            
            // Ensure namesList is a string
            if (!predefinedData.namesList) {
                predefinedData.namesList = '';
            }
            
            // Set up a helper function to check if a name exists in the namesList (case-insensitive)
            const nameExistsInList = (name, list) => {
                if (!name || !list) return false;
                return list.toLowerCase().split(',').map(n => n.trim()).includes(name.toLowerCase());
            };
            
            // Add sender to namesList if needed
            if (urlSender && !nameExistsInList(urlSender, predefinedData.namesList)) {
                predefinedData.namesList = predefinedData.namesList ? 
                    `${predefinedData.namesList}, ${urlSender}` : urlSender;
            }
            
            // Add receiver to namesList if needed
            if (urlReceiver && !nameExistsInList(urlReceiver, predefinedData.namesList)) {
                predefinedData.namesList = predefinedData.namesList ? 
                    `${predefinedData.namesList}, ${urlReceiver}` : urlReceiver;
            }
            
            // Populate dropdowns
            populateNameDropdowns();
            populateCategoryDropdown();
            
            // Set up event handlers
            handleDropdownChanges();
            
            // Check for redirects
            checkForRedirect();
            
            // Prefill the form
            prefillForm();

            // Pre-fill form from URL parameters (this will override predefined data if URL params exist)
            urlParams.forEach((value, key) => {
                // Skip namesList and categoriesList parameters
                if (key !== 'namesList' && key !== 'categoriesList') {
                    const field = document.getElementById(key.toLowerCase());
                    if (field) {
                        if (field.tagName === 'SELECT') {
                            // For select2 dropdowns
                            const option = new Option(value, value, true, true);
                            $(field).append(option).trigger('change');
                        } else {
                            field.value = value;
                        }
                    }
                }
            });

            // Form submission
            $('#transactionForm').on('submit', async function(e) {
                e.preventDefault();
                
                const form = $(this);
                const submitBtn = form.find('button[type="submit"]');
                const statusMessage = $('#statusMessage');
                
                // Show loading state
                form.addClass('loading');
                submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Processing...');
                
                try {
                    const formData = new FormData(this);
                    const data = {};
                    
                    // Define the exact fields we want to return
                    const allowedFields = [
                        'status', 'value', 'currency', 'transaction_date', 
                        'sender', 'sender_account', 'receiver', 'receiver_account',
                        'reference_id', 'type', 'category', 'reporter_name',
                        'notes', 'reporter_notes', 'proof_link', 'file_name'
                    ];
                    
                    // Convert FormData to JSON with only allowed fields
                    for (let [key, value] of formData.entries()) {
                        if (allowedFields.includes(key.toLowerCase())) {
                            data[key.toLowerCase()] = value;
                        }
                    }
                    
                    // Convert value to number
                    if (data.value) {
                        data.value = parseFloat(data.value);
                    }
                    
                    // Add proof_link and file_name from URL if present
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.has('proof_link')) {
                        data.proof_link = urlParams.get('proof_link');
                    }
                    
                    if (urlParams.has('file_name')) {
                        data.file_name = urlParams.get('file_name');
                    }
                    
                    const response = await fetch('https://ziadelshayeb1.app.n8n.cloud/webhook/transaction', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    
                    // For debugging - log the exact data being sent
                    console.log('Sending transaction data:', data);
                    
                    if (response.ok) {
                        statusMessage.removeClass('status-error').addClass('status-success');
                        statusMessage.html('<i class="fas fa-check-circle"></i> Transaction confirmed successfully!');
                        statusMessage.show();
                        
                        // Reset form after success
                        setTimeout(() => {
                            resetForm();
                        }, 2000);
                    } else {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    
                } catch (error) {
                    statusMessage.removeClass('status-success').addClass('status-error');
                    statusMessage.html('<i class="fas fa-exclamation-circle"></i> Error: ' + error.message);
                    statusMessage.show();
                } finally {
                    form.removeClass('loading');
                    submitBtn.html('<i class="fas fa-check"></i> Confirm Transaction');
                }
            });
            
            // Load saved form state from localStorage
            loadFormStateFromStorage();
        });

        function resetForm() {
            document.getElementById('transactionForm').reset();
            $('#sender, #receiver, #category, #type, #status').val(null).trigger('change');
            $('#statusMessage').hide();
            
            // Reset date to current
            const now = new Date();
            const formattedDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            $('#transaction_date').val(formattedDate);
            
            // Remove "Add Account" buttons
            $('.form-group').find('button').remove();
            
            // Clear localStorage
            localStorage.removeItem('transactionFormState');
            
            // Reset the URL to remove parameters
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>
</body>
</html>